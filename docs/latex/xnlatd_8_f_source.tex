\hypertarget{xnlatd_8_f_source}{}\doxysection{xnlatd.\+F}
\label{xnlatd_8_f_source}\index{/Users/Transmutex/Simulation/ADS\_SimulationCode/xnsect/xngeom/xnlatd.F@{/Users/Transmutex/Simulation/ADS\_SimulationCode/xnsect/xngeom/xnlatd.F}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00001}00001 \textcolor{comment}{*CMZ :  2.00/02 05/06/96  09.38.14  by  Federico Carminati}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00002}00002 \textcolor{comment}{*-\/-\/ Author :    Federico Carminati   30/01/95}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00003}00003       \textcolor{keyword}{SUBROUTINE }xnlatd(PARAM,HINP,V,SNMAX,IEX,SNEXT,OUTP,IHIT)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00004}00004 \textcolor{comment}{************************************************************************}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00005}00005 \textcolor{comment}{*                                                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00006}00006 \textcolor{comment}{*     Finds intersection of a particle with a lattice (hexagonal       *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00007}00007 \textcolor{comment}{*     or square) of bars                                               *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00008}00008 \textcolor{comment}{*                                                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00009}00009 \textcolor{comment}{*     PARAM     (input) array of 3 with the parameters of the          *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00010}00010 \textcolor{comment}{*               lattice:                                               *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00011}00011 \textcolor{comment}{*               PARAM(1) = X distance of the bars                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00012}00012 \textcolor{comment}{*               PARAM(2) = radius of bars                              *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00013}00013 \textcolor{comment}{*               PARAM(3) = Z half dimension of the lattice             *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00014}00014 \textcolor{comment}{*     HINP      (input) array of 3 with the coordinates of the         *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00015}00015 \textcolor{comment}{*               particle                                               *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00016}00016 \textcolor{comment}{*     V         (input) array of 3 with the particle speed             *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00017}00017 \textcolor{comment}{*     SNMAX     (input) maximum distance that the particle is          *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00018}00018 \textcolor{comment}{*               allowed to travel                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00019}00019 \textcolor{comment}{*     IEX       (input) lattice structure                              *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00020}00020 \textcolor{comment}{*               1 = hexagonal lattice with rows of bars parallel to    *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00021}00021 \textcolor{comment}{*                   the X axis                                         *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00022}00022 \textcolor{comment}{*               0 = square lattice                                     *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00023}00023 \textcolor{comment}{*     SNEXT     (output) distance to the intersection with the         *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00024}00024 \textcolor{comment}{*               sphere along the particle direction                    *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00025}00025 \textcolor{comment}{*     IHIT      (output) intersection flag                             *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00026}00026 \textcolor{comment}{*               = 1 bar is hit from inside                             *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00027}00027 \textcolor{comment}{*               = -\/1 bar is hit from outside                           *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00028}00028 \textcolor{comment}{*               = 0 bar is not hit                                     *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00029}00029 \textcolor{comment}{*     OUTP      (output) array of 3 with the final position of the     *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00030}00030 \textcolor{comment}{*               particle                                               *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00031}00031 \textcolor{comment}{*                                                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00032}00032 \textcolor{comment}{************************************************************************}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00033}00033       \textcolor{keywordtype}{IMPLICIT DOUBLE PRECISION} (a-\/h,o-\/z)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00034}00034       parameter(one=1,zero=0,half=one/2,hmprec=1e-\/15,}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00035}00035      +           sqrt3h=0.866025403784438597)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00036}00036 \textcolor{keywordtype}{      REAL} HINP(3),PARAM(3),OUTP(3),V(3),SNMAX,SNEXT}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00037}00037       \textcolor{keywordtype}{LOGICAL} ROTATE}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00038}00038       dimension x(6)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00039}00039       lint(xy)=int(xy)-\/(half-\/sign(half,xy))}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00040}00040 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00041}00041 \textcolor{comment}{* -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00042}00042 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00043}00043 \textcolor{comment}{* -\/-\/-\/> Find particle direction}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00044}00044       \textcolor{keyword}{CALL }xndirv(hinp,v,x,costh,sinth,cosph,sinph,rotate)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00045}00045       \textcolor{keywordflow}{GOTO} 10}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00046}00046 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00047}00047       entry xnltnd(param,hinp,v,snmax,iex,snext,outp,inter)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00048}00048 \textcolor{comment}{************************************************************************}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00049}00049 \textcolor{comment}{*                                                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00050}00050 \textcolor{comment}{*     Same as previous entry, but particle velocity is normalised      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00051}00051 \textcolor{comment}{*     to 1                                                             *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00052}00052 \textcolor{comment}{*                                                                      *}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00053}00053 \textcolor{comment}{************************************************************************}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00054}00054 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00055}00055 \textcolor{comment}{* -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00056}00056 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00057}00057 \textcolor{comment}{* -\/-\/-\/> Load particle position and direction in double precision}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00058}00058       x(1) = hinp(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00059}00059       x(2) = hinp(2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00060}00060       x(3) = hinp(3)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00061}00061       x(4) = v(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00062}00062       x(5) = v(2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00063}00063       x(6) = v(3)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00064}00064 \textcolor{comment}{* -\/-\/-\/> Suppose we do not hit any bar}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00065}00065    10 dnext = snmax}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00066}00066       ihit = 0}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00067}00067 \textcolor{comment}{* -\/-\/-\/> Prepare some useful constants}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00068}00068 \textcolor{comment}{* -\/-\/-\/> Distance of bars along X}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00069}00069       disbar = param(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00070}00070 \textcolor{comment}{* -\/-\/-\/> Its inverse}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00071}00071       disbai = one/param(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00072}00072 \textcolor{comment}{* -\/-\/-\/> Distance of bar planes along Y}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00073}00073       \textcolor{keywordflow}{IF}(iex.EQ.1) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00074}00074          displa = param(1)*sqrt3h}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00075}00075       \textcolor{keywordflow}{ELSE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00076}00076          displa = param(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00077}00077 \textcolor{keywordflow}{      ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00078}00078 \textcolor{comment}{* -\/-\/-\/> Its inverse}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00079}00079       displi = one/displa}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00080}00080 \textcolor{comment}{* -\/-\/-\/> Bar radius and its square}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00081}00081       barrad = param(2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00082}00082       barra2 = barrad**2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00083}00083 \textcolor{comment}{* -\/-\/-\/> Now find the axis in the plane X-\/Y which is closer to the}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00084}00084 \textcolor{comment}{*      particles direction and call it X}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00085}00085 \textcolor{comment}{* -\/-\/-\/> The algorithm work with inverted X and Y for historical reasons}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00086}00086       x0 = x(2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00087}00087       y0 = x(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00088}00088       hnorm = one/sqrt(x(4)**2+x(5)**2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00089}00089       alpha = x(5)*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00090}00090       beta  = x(4)*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00091}00091       rotate=.false.}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00092}00092       \textcolor{keywordflow}{IF}(abs(alpha).LT.half) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00093}00093          \textcolor{keywordflow}{IF}(iex.EQ.1) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00094}00094 \textcolor{comment}{* -\/-\/-\/> Rotate everything by 60 degrees, the distance stays the same}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00095}00095             y0 = x(1)*half +x(2)*sqrt3h}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00096}00096             x0 = -\/x(1)*sqrt3h+x(2)*half}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00097}00097             beta = ( x(4)*half +x(5)*sqrt3h)*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00098}00098             alpha = (-\/x(4)*sqrt3h+x(5)*half )*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00099}00099             rotate=.true.}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00100}00100          \textcolor{keywordflow}{ELSE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00101}00101 \textcolor{comment}{* -\/-\/-\/> Rotate everything by 90 degrees}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00102}00102             x0 = x(1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00103}00103             y0 = x(2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00104}00104             alpha = x(4)*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00105}00105             beta = x(5)*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00106}00106 \textcolor{keywordflow}{         ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00107}00107 \textcolor{keywordflow}{      ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00108}00108 \textcolor{comment}{* -\/-\/-\/> Find starting point and direction for the scan of the bar planes}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00109}00109       istart = (nint(x0*displi)+}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00110}00110      +          (sign(one,x0)-\/sign(one,alpha))*half)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00111}00111       istep  = sign(one,alpha)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00112}00112       iend   = istart+istep*(snmax*displi+1)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00113}00113 \textcolor{comment}{* -\/-\/-\/> Some more useful constants}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00114}00114       alphai=one/alpha}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00115}00115 \textcolor{comment}{* -\/-\/-\/> Loop on planes of bars}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00116}00116       \textcolor{keywordflow}{DO} 30 ix=istart,iend,istep}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00117}00117 \textcolor{comment}{* -\/-\/-\/> Find X of bar plane}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00118}00118          xx=ix*displa}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00119}00119 \textcolor{comment}{* -\/-\/-\/> Prepare for further calculations}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00120}00120          xx2=xx**2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00121}00121          delx2 = (x0-\/xx)**2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00122}00122          \textcolor{keywordflow}{IF}(iex.EQ.1) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00123}00123 \textcolor{comment}{* -\/-\/-\/> Slightly more complicated... we need the shift for the odd planes}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00124}00124             shift=disbar*half*mod(ix,2)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00125}00125          \textcolor{keywordflow}{ELSE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00126}00126             shift=0}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00127}00127 \textcolor{keywordflow}{         ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00128}00128 \textcolor{comment}{* -\/-\/-\/> Compute y range -\/ gamma is the projection of the}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00129}00129 \textcolor{comment}{*      y coordinate at the plane IX onto the normal to the line of}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00130}00130 \textcolor{comment}{*      flight}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00131}00131          gamma=beta*(xx-\/x0)+alpha*y0}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00132}00132          ya=(gamma-\/barrad)*alphai}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00133}00133          yb=(gamma+barrad)*alphai}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00134}00134 \textcolor{comment}{* -\/-\/-\/> If a bar centre's Y coordinate is between Y1 and Y2 we may hit it}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00135}00135          y1=min(ya,yb)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00136}00136          y2=max(ya,yb)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00137}00137 \textcolor{comment}{* -\/-\/-\/> Find possible bar centres in this range}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00138}00138          iy1=lint((y1-\/shift)*disbai)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00139}00139          iy2=lint((y2-\/shift)*disbai)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00140}00140 \textcolor{comment}{* -\/-\/-\/> If at least one bar centre}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00141}00141          \textcolor{keywordflow}{IF}(iy1.LT.iy2)\textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00142}00142 \textcolor{comment}{* -\/-\/-\/> Loop on candidate bars}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00143}00143             \textcolor{keywordflow}{DO} 20 iy=iy1,iy2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00144}00144 \textcolor{comment}{* -\/-\/-\/> In case of hex, shift bars}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00145}00145                y=iy*disbar+shift}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00146}00146 \textcolor{comment}{* -\/-\/-\/> Still check that bar centre is in the right interval}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00147}00147                \textcolor{keywordflow}{IF}(y1.LE.y.AND.y.LE.y2)\textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00148}00148 \textcolor{comment}{* -\/-\/-\/> Test for intersection}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00149}00149                   a=alpha*(x0-\/xx)+beta*(y0-\/y)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00150}00150                   d2=delx2+(y0-\/y)**2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00151}00151                   det=max(a**2-\/(d2-\/barra2),zero)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00152}00152                   c=sqrt(det)}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00153}00153 \textcolor{comment}{* -\/-\/-\/> Find two points of intersection}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00154}00154                   t1=-\/a-\/c}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00155}00155                   t2=-\/a+c}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00156}00156                   \textcolor{keywordflow}{IF}(t1.GT.0.0.AND.dnext.GT.t1) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00157}00157 \textcolor{comment}{* -\/-\/-\/> Accept first distance}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00158}00158                      xhtbar = y}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00159}00159                      yhtbar = xx}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00160}00160                      dnext=t1}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00161}00161                      ihit=1}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00162}00162 \textcolor{comment}{* -\/-\/-\/> If both distances positive, hit is from outside}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00163}00163                      \textcolor{keywordflow}{IF}(t1*t2.GT.0.0) ihit=-\/ihit}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00164}00164                   \textcolor{keywordflow}{ELSEIF}(t2.GT.0.0.AND.dnext.GT.t2)\textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00165}00165 \textcolor{comment}{* -\/-\/-\/> Accept second distance}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00166}00166                      xhtbar = y}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00167}00167                      yhtbar = xx}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00168}00168                      dnext=t2}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00169}00169                      ihit=1}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00170}00170 \textcolor{comment}{* -\/-\/-\/> If both distances positive, hit is from outside}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00171}00171                      \textcolor{keywordflow}{IF}(t1*t2.GT.0.0) ihit=-\/ihit}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00172}00172 \textcolor{keywordflow}{                  END IF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00173}00173 \textcolor{keywordflow}{               END IF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00174}00174    20       \textcolor{keywordflow}{CONTINUE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00175}00175 \textcolor{keywordflow}{         END IF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00176}00176 \textcolor{comment}{* -\/-\/-\/> If we got a hit, stop searching}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00177}00177          \textcolor{keywordflow}{IF}(ihit.NE.0) \textcolor{keywordflow}{GOTO} 40}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00178}00178    30 \textcolor{keywordflow}{CONTINUE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00179}00179 \textcolor{comment}{* -\/-\/-\/> convert distance in 3D}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00180}00180    40 \textcolor{keywordflow}{IF}(ihit.NE.0) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00181}00181          dnext=dnext*sqrt((x(4)**2+x(5)**2+x(6)**2))*hnorm}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00182}00182          \textcolor{keywordflow}{IF}(dnext.LT.snmax) \textcolor{keywordflow}{THEN}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00183}00183 \textcolor{comment}{* -\/-\/-\/> Find end point}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00184}00184             outp(1) = x(1)+x(4)*dnext}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00185}00185             outp(2) = x(2)+x(5)*dnext}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00186}00186             outp(3) = x(3)+x(6)*dnext}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00187}00187 \textcolor{keywordflow}{         ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00188}00188       \textcolor{keywordflow}{ELSE}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00189}00189 \textcolor{comment}{* -\/-\/-\/> No interaction before max distance}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00190}00190          ihit=0}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00191}00191 \textcolor{keywordflow}{      ENDIF}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00192}00192       snext = dnext}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00193}00193 \textcolor{comment}{*}}
\DoxyCodeLine{\Hypertarget{xnlatd_8_f_source_l00194}00194       \textcolor{keyword}{END}}

\end{DoxyCode}
